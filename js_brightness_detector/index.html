<!doctype html>
<html lang="">

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css">
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-min.css">
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css">

  <style>

    img {
      width: 85%;
      margin: 1rem;
      cursor: pointer;
      border: 1px solid #CCC;
      display: block;
      box-sizing: content-box;
      height: 70%;
    }

  </style>
</head>

<body>
  <!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

  <div class="wrapper" style="width:85%;max-width: 40rem;margin: 0 auto;">
    <div class="pure-g">
      <div class="pure-u-1-1">
        <h1>Javascript Brightness detector.</h1>
      </div>
      <div class="pure-g">
        <div class="pure-u-1-1">
          <p>Click on the image to process</p>
        </div>
        <div class="pure-u-1-1">
          <div class="pure-g">
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img src="./images/black_white.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img src="./images/background.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/grass.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/nature1.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/nature2.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/nature3.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/bright.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/sky.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/bgi-5.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/bgi-8.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/bgi-16.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img src="./images/bgi-27.jpg">
            </div>
            <div class="pure-u-1-1 pure-u-sm-1-5">
              <img  src="./images/bgi-28.jpg">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script
          src="https://code.jquery.com/jquery-3.4.1.min.js"
          integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
          crossorigin="anonymous"></script>
  <script>

  $(document).ready(function(){
    $("img").click(function(){
      var imgurl = $(this).attr("src");
      var ts = new Date().getTime();
      GetImageQuadrantBrightness(imgurl,function (brightness_level) {
        var te = new Date().getTime();
        alert("Brightness Level: "+brightness_level + " - Elapsed time: "+((te-ts)).toFixed(1)+"[ms]");
      });
    })
  })

  function GetImageBrightness(imageSrc,callback) {
    var img = document.createElement("img");
    img.src = imageSrc;
    img.style.display = "none";
    document.body.appendChild(img);

    var colorSum = 0;

    img.onload = function() {
      // crea il canvas
      var canvas = document.createElement("canvas");
      canvas.width = this.width;
      canvas.height = this.height;

      var ctx = canvas.getContext("2d");
      ctx.drawImage(this,0,0);

      var imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      var data = imageData.data;
      var r,g,b,avg;

      for(var x = 0, len = data.length; x < len; x+=4) {
        r = data[x];
        g = data[x+1];
        b = data[x+2];

        avg = Math.floor((r+g+b)/3);
        colorSum += avg;
      }

      var brightness = Math.floor(colorSum / (this.width*this.height));
      callback(brightness);
    }
  }

  function GetImageQuadrantBrightness(imageSrc, callback) {
    var img = document.createElement("img");
    img.src = imageSrc;
    img.style.display = "none";
    document.body.appendChild(img);



    img.onload = function() {
      // crea il canvas
      var canvas = document.createElement("canvas");
      canvas.width = this.width;
      canvas.height = this.height;

      var ctx = canvas.getContext("2d");
      ctx.drawImage(this,0,0);

      var imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      var data = imageData.data;

      var fnSampleQuadrant = function(canvas, ImageData,nQuadrant) {
        var r,g,b,avg = 0;
        var colorSum = 0;

        var xs = 0;
        var xe = Math.floor(canvas.width / 2);
        var ys = 0;
        var ye = Math.floor(canvas.height / 2);

        switch (parseInt(nQuadrant))
        {
          case 1:
            xs = Math.floor(canvas.width / 2)+1;
            xe = canvas.width;
            break;
          case 2:
            xs = Math.floor(canvas.width / 2)+1;
            xe = canvas.width;
            ys = Math.floor(canvas.height / 2)+1;
            ye = canvas.height;
            break;
          case 3:
            ys = Math.floor(canvas.height / 2)+1;
            ye = canvas.height;
            break;
        }

        var nSamples = 0;
        for (var y=ys;y<ye;y++) {
          for (var x = xs; x < xe; x++) {
            var index = y * (canvas.width * 4) + x * 4;
            r = data[index];
            g = data[index+1];
            b = data[index+2];
            avg = Math.floor((r+g+b)/3);
            colorSum += avg;
            nSamples++;
          }
        }

        return brightness = Math.round(colorSum / nSamples);
      };


      callback([fnSampleQuadrant(canvas,data,0),fnSampleQuadrant(canvas,data,1),fnSampleQuadrant(canvas,data,2),fnSampleQuadrant(canvas,data,3)]);
    }
  }

</script>

</body>

</html>
